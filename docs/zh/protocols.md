仙女座元宇宙商业协议拥有无与伦比的开放性，方便与各种元宇宙游戏以及生态相结合，进行交易和互操作。

基于以太坊ERC-20、ERC-721、ERC-1155以及牛顿NewChain NRC-6、NRC-7、NRC-50等基础协议，仙女座元宇宙商业生态构建了大量NFT数字资产交易协议，称之为仙女座元宇宙商业协议。元宇宙商业协议是一组协议，具体包含下述若干子协议。

仙女座元宇宙是一个去中心化的、跨链的网络，支持NFT的铸造、交易、融资等功能。所有协议都具有免许可的开放性和抗审查性，方便与各种元宇宙游戏结合、互通，以及进行交易。所有协议均可以设置费用开关，在必要时创造收入，支撑治理代币的价值。

### 定价与交易协议

#### Abstract

定价与交易协议是一种逐步发现NFT价值并能够提供用户间交易NFT的链上协议，该协议由一组合约组成。用户在买卖NFT之前，需要授权允许该协议以既定的合约逻辑转移NFT。该协议包括版税、协议费以及交易，支持满足NRC-7/ERC-721/ERC-1155标准的任意NFT的交易。

#### Specification

版税是该协议提供的一种接口，当且仅当NFT中支持了指定的接口后，该协议才能够支付创作者版税，如无设定，则版税会转给该协议本身。

```
function royaltyFeeInfo(address token) external view returns (address recipient, uint8 permil);
```

设定版税的接口需要实现该接口，该接口返回如下信息：

- recepient: address类型，版权税接收者地址
- permit: uint8类型，最大值为255， 版权税比例，基数为1000，则版税最大为 25.5%

协议费是使用该协议所需要支付的费用，该费用可以由DAO进行更改，初始值为 `5%`。其接口如下：

```
function protocolFeeInfo() external view returns (address recipient, uint8 permil);
```

该接口返回如下信息：

- recipient：address类型，协议费用接收地址
- permit: uint8类型，最大值为 255， 费用比例，基数为1000，则最大值为 25.5%

交易协议会有多种不同的交易策略，交易策略需要有实现如下接口：

```
interface IStrategy {
    function canExecute(
        uint256 deadline,
        bytes memory params,
        address bidder,
        uint256 bidPrice
    ) external view returns (bool);

    function canBid(
        uint256 deadline,
        bytes memory params,
        address bidder,
        uint256 bidPrice,
        uint256 bestBidPrice,
        uint256 bestBidBlock
    ) external view returns (bool);
}
```

其中，canExecute判断订单在该策略是否可以执行交易功能；canBid判断订单在该策略下是否可以叫价。

交易策略分为以下几种类型：

- 固定价格交易
  - 卖方以固定价格挂单售卖
  - 买方以该价格进行购买
- 英式拍卖
  - 英式拍卖是一种增价拍卖
  - NFT卖方设置最低价、保留价（默认为最低价）、到期时间
  - 买家会针对该NFT进行出价，该协议保证了只能增价拍卖，且最高出价用户不能退出
  - 当拍卖截止时，仅当最高出价不小于保留价的时候，最高出价者才能获取该NFT
- 荷兰拍卖
  - 荷兰式拍卖是减价式拍卖
  - 用户设置最高价及最低价，并设定竞拍时间，该NFT的价格会按照时间从最高价线性递减到最低价，直到有人购买或者竞拍时间结束（流拍）
  - 该协议能够保证在同一时刻仅有一个用户成交，因此不会出现两个用户同时叫价后再增加拍卖的情况
- 永续拍卖
  - 用户设置初始价格与加价幅度后，把NFT转由该协议控制
  - 永续拍卖一经开始后，任何人均可以按照最初设置的加价幅度购买该NFT
  - 当且仅当最后一个成交人成交后从协议中撤出该NFT后永续拍卖才算停止
- 支持用户出价
  - 买方用户可以针对任意指定NFT进行出价
  - 该NFT的拥有者同意该价格后可以以该价格出售给买方

该协议的部分参数可以治理，即协议owenr为DAO合约。可以治理参数及说明如下：

- 更改协议费用
- 新增或删除交易策略


### 代理协议

#### Abstract

代理协议实现了任何人可以把自己拥有的NFT商品变成开放库存，使得其他人可以以无需许可（permissionless）的方式代理该NFT商品，并灵活指定代理价格，在成功销售后代理商和所有人之间依照智能合约约定的分配方式进行分成。

#### Specification

- 创建开放库存

```
function createOpenStock(assetAddress, nftId, amount, floorPrice, revenueSplit, ceilingPrice, validThru);
```

NFT商品的拥有者创建开放库存。传入该NFT的合约地址，编号，以及数量（对于NRC-50/ERC-1155多版本NFT而言）。

同时，还可以指定最低目标价（地板价），限定代理商销售的底价；指定分润比例；以及指定最高目标价（天花板价格），当代理商售价高于该价格，则超出部分完全归代理商，不再进行分润。

最后，指定有效期（区块高度）。过期自动失效。

库存一经创建，便在区块链上公开可见。在有效期内，所有者不可以取回该NFT。

- 撤销库存

```
function withdrawOpenStock(assetAddress, nftId, amount);
```

有效期到，所有者可以撤销库存，并取回NFT。

- 代理库存

```
function mintShadowNFT(assetAddress, nftId, amount);
```

代理库存的过程其实是一个基于某个开放库存铸造一个或者一批“影子NFT”的过程。

这些影子NFT可以被任意铸造，并放到任何代理商习惯的平台上进行挂单销售。

影子NFT复制了库存NFT的元数据，因而具有相同的外观。唯一不同的是，购买影子NFT后，买家需要到库存合约处取回NFT“原件”。

影子NFT拥有一个单独的purchase方法，通过该方法下单，可以依照库存创建者的要求约束最低价、分润比例和最高价，并即时完成分润。

影子NFT合约会即时记录并在下单时索引当前库存余量，如果库存不足，则下单失败。这样可以避免多人代理时超售的问题。

- 取回原件

```
function redeem(shadownNFT);
```

用户从代理商处购得影子NFT后，可以自行到库存合约处取回NFT“原件”，同时销毁对应的影子NFT。


### 盲盒协议

#### Abstract

盲盒交易又称随机分发协议，是避免交易对敲、增加流动性、以及如何发现有价值NFT的一种玩法。仙女座盲盒协议，可以针对一批NFT进行售卖，在一批NFT售卖结束后用户才能知道具体所购的NFT的内容。

区块链能够保证盲盒的公平公正。NFT制作后会进行排序，用户购买NFT后获得用户编号`user_index`，带销售结束后，获取链上随机数start_index，则用户实际获取的NFT的编号为： `index = (start_index + user_index) % total`

#### Specification

盲盒购买过程：

- NFT制作与打包
  - 针对NFT进行标号并获取其sha256的hash
  - 计算总的hash值： hash = Keccak-256(hash0 + hash1 + .... + hash10k)
  - 合约部署同时指定该总的hash值

- 用户购买
  - 用户购买后获取`user_index`，但此时对应的NFT的index未知
  - 用户购买后可以随时在二级市场进行出售，但此时出售的商品具体内容未知

```
function buy(uint256 number);
```

- 公布内容
  - 公布内容同时生成`start_index`

```
function publish() {
    start_index = random();
}
```

### 合成商品协议

#### Abstract

合成商品协议是把多个NFT进行组合，合成一个新的NFT。NFT持有者可以对其持有的NFT数字资产，进行编程、再创造、添加一些实用性的功能。可以运用在数字艺术品签名、商业合同签署等领域。NFT持有者把其NFT授权给某个特定的合约并锁定，邀请其他NFT持有者对该NFT进行再创造，铸造出一个具有全新特性的NFT数字资产。

每个行业都有不同的合成需求，针对不同的行业应用场景我们会给出对应的标准协议解决方案。

例如：
在合同签署领域，根据仙女座开发的合同签署标准合约，商业公司A把签章NFT、商业公司B把其签署的商业合同NFT 共同发送给给智能合约，合约接收到原始文件，自动生成一份不可篡改的新合同，并把文件hash记录在链。

例如：
在游戏领域，虚拟人生游戏中，用户可以通过NFT装备设定虚拟人设，在特殊场景中两个游戏中玩家可以用特定的NFT合成出一个共同的宠物，该宠物基因只属于这两个玩家。

#### Specification

原料NFT： 需要消耗或需要被合成的NFT

合成NFT:  基于一个或多个原料NFT所合成的新的NFT

合成NFT需要有原料NFT的指定token的转账权限，合成NFT在合成（铸币）时，需要把原料NFT转入合成NFT的合约并进行记录。
合成NFT的铸币接口如下：

```
function mint(address[] tokens, uint256[] ids, uint256[] amounts) returns (uint256 id);
```

其中，要求tokens、ids以及amounts数组的长度必须一致且一一对应。返回合成的新的ID。


### 流动性协议

#### Abstract

NFT的流动性协议是，通过池化（Pooling），把低流动性的非同质代币（NFT）转换为高流动性的同质代币（FT）一种协议。

用户把NFT转入NFT池子，依照1:10000铸造同质代币，称之为Pool Token（NRC6），返给用户，每个池子的Pool Token都是不同的NRC-6代币。Pool Token可以与其他DeFi协议比如newswap进行组合，或者偿还以取回池子中的NFT。

#### Specification

- 池子的建立

```
function createVault(name, symbol, assetAddress) returns (vaultId);
```

任何人都可以基于指定的NFT合约或者指定合约内一些列的ID来创建新的池子。

创建池子需要如下字段：

- NFT的合约地址
- 池子的名称，也是创建的NRC-6的token的名称
- 池子的符号，也是创建的NRC-6的token的符号

NFT合约地址不可变更，默认情况下所有ID均可加入到该池子中。

- 品质保证

```
function setIsEligible(vaultId, nftIds[], true/false);
function setRange(vaultId, start, end);
```

池子管理员可以通过限定合格NFT ID的列表、范围，或者取反进行标记。
也可以不对NFT ID进行限定，默认包含指定NFT合约下的任意ID。

- 池子发布

```
function finalizeVault(vaultId);
```

池子管理员确定将池子最终化（finalize）并“发布”后，任何参数不可再修改，池子对外可操作。

- 铸造Pool Token

```
function mint(vaultId, ntfIds[]);
```

池子一旦发布，任何人都可以向池子中存入合格的NFT，每个NFT获得10000枚相应池子的的Pool Token。

- NFT赎回

```
function redeem(vaultId, numNFTs);
```

任何人只要持有池子的Pool Token，可按每10000枚Pool Token赎回一枚NFT，赎回采用盲盒方式，不可指定NFT。


### 通用积分发行协议

#### Abstract

交易节点可以简单、快捷的在仙女座Client端发行数字资产，并通过积分运营维护自己的粉丝群体。积分的合理释放及应用会带动粉丝群体的增长，能够最大化各方的利益。  

交易节点内的数字资产发行与管理由节点自主运营，积分发行是交易节点获取增量用户的一个重要手段之一。交易节点可以用空投、锁定挖矿、购物激励、NewSwap定价交换 等多种营销工具把积分交换出去，以换取用户与交易的新增量。

例如：交易节点发行一定规模的积分，积分可以通过仙女座提供的空投策略协议，向生态发送积分，收到积分的用户进而转换为节点的私域流量。

例如：交易节点可以利用流动性挖矿协议，创建一个积分矿池，自定义锁定NewChain的NRC6代币去挖积分，这些主动挖矿产生的积分，最后都会重新回流到交易节点进行消费。

#### Specification

积分发行基本需要以下参数：

- Name: 名称
- Symbol: 符号，一般为三个字符
- totalSupply: 发行总量

```
function createToken(string name, string symbol, uint256 totalSupply) returns (address);
```

积分的释放曲线可定制，一般有如下几种方式：

- 一次性释放
- 线性释放

### 分布式信用协议

#### Abstract

即时信用协议是一种链上实时增强信用的协议，通过在交易开始时向智能合约中质押数字资产以增信，以实现实物的点到点交易，亦可用于可兑换NFT的可靠承兑。在交易结束后即刻解除增信资产的质押，以释放流动性，从而最大化抵押资产的利用效率。

#### Specification

- 创建交易

```
function placeOrder() inState(State.Inactive) condition(staking == 2 * price);
```

任何人，作为购买方或兑换方角色，都可以通过调用智能合约创建交易。通常，这个动作发生在购买方点击用户界面对某个商品下单，或者兑换方对某个可兑换NFT进行兑换时。

在创建交易时，创建者需要向智能合约中质押两倍于售价的等值担保资产（NRC-6代币）为自己发起的该笔交易增信。若是兑换NFT，则要质押该NFT，由于在购买NFT时已经支付过1倍价值，所以此时只需要再额外支付1倍价值，达成双倍质押即可。

购买方或兑换方需要质押担保资产以增信，从而实现对链下履约的承诺约束。而且购买方或兑换方需要质押与交易对手方即出售方或承兑方等值的担保资产，即两倍于售价的等值担保资产。这是因为，如果购买方或兑换方只质押一倍售价的等值担保资产，则其增信只是出售方或承兑方的一半，如果购买方或兑换方违约，在收到物品后不进行最后的确认完成，则购买方或兑换方的损失也是出售方或承兑方的一半，因而无法有效确保购买方或兑换方诚信履约。

如果降低增信一半的要求，即要求购买方或兑换方和出售方或承兑方双方都只质押一倍于售价的等值担保资产，那么对于即付货款的场景，购买方或兑换方若在收到物品后不进行最后的确认完成，则购买方或兑换方没有损失，而出售方或兑换方承受物品和质押资产的双重损失，因而无法有效确保购买方或兑换方诚信履约。

- 放弃交易

```
function abortOrder() onlyBuyer inState(State.Created);
```

在出售方或承兑方介入该交易前，交易发起者可以放弃该交易并释放质押的担保资产。

- 接受交易

```
function acceptPurchase() onlySeller inState(State.Created) condition(staking == 2 * price);
```

出售方或承兑方可以通过点击接受介入该笔交易。接受交易时需要同时向智能合约中质押与交易对手方对等的担保资产（NRC-6代币），即两倍于售价的等值担保资产。

出售方或承兑方需要质押担保资产以增信，从而实现对链下履约的承诺约束。而且出售方或承兑方需要质押与交易对手方即购买方或兑换方等值的担保资产，即两倍于售价的等值担保资产。这是因为，如果出售方或承兑方只质押一倍售价的等值担保资产，则其增信只是购买方或兑换方的一半，如果出售方或承兑方违约，则出售方或承兑方的损失也是购买方或兑换方的一半，因而无法有效确保出售方或承兑方诚信履约。

出售方或承兑方介入交易后，交易被锁定。出售方或承兑方可以开始处理链下物流相关事宜，并等待购买方或兑换方的验收和确认。

当双方出现争议时，可以自行协商解决，也可以通过仲裁协议解决。由于双方均有双倍价值质押，双方有充足动力推动问题解决。

- 确认完成

```
function confirmReceived() onlyBuyer inState(State.Locked);
```

购买方或兑换方收货验收后，点击确认收货并结束交易。智能合约把锁定的货款（如有）发送给出售方或承兑方一方，并将双方剩余的担保资产分别返还给出售方或承兑方和购买方或兑换方。

这样的协议设计，使得出售方或承兑方无需提前准备负担全部库存的担保资产，也无需在交易实际发生之前为全部库存进行增信，从而极大减轻了出售方或承兑方的资金压力和负担。
同时，增信资产的担保抵押和解抵押在链上实时根据交易状态不断发生，从而最大化了出售方或承兑方增信资产的资金效率。
通常而言，出售方或承兑方只需要根据实际并发交易量的统计数据准备充足的担保资产，并在季节性旺季提前增加准备金，从而较好地应对协议要求。